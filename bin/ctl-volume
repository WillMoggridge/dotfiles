#!/usr/bin/python3

import argparse
from math import ceil
from subprocess import Popen, PIPE

SINK_NAME = "alsa_output.pci-0000_00_1b.0.analog-stereo"
VOL_MIN = 0
VOL_MAX = 150


def get_volume():
    volume_proc = Popen(['pa-getvol'], stdout=PIPE)
    volume, stderr = volume_proc.communicate()
    return ceil(int(volume, 0) / 655.36)


def get_arguments():
    parser = argparse.ArgumentParser(description='change volume')
    parser.add_argument(
        'action', type=str, choices=['raise', 'lower', 'mute'],
        help='lower, raise, or mute'
    )
    return parser.parse_args()


if __name__ == "__main__":
    args = get_arguments()
    action = args.action

    volume = get_volume()
    print(volume)

    pactl = '/usr/bin/pactl'

    if action == 'lower' and volume > VOL_MIN:
        Popen([pactl, 'set-sink-volume', '1', '-5%'])
        Popen([pactl, 'set-sink-mute', '1', '0'])

    if action == 'raise' and volume < VOL_MAX:
        Popen([pactl, 'set-sink-volume', '1', '+5%'])
        Popen([pactl, 'set-sink-mute', '1', '0'])

    if action == 'mute':
        Popen([pactl, 'set-sink-mute', '1', 'toggle'])

    Popen(['pkill', '-RTMIN+10', 'i3blocks'])
